<!DOCTYPE html>
<html lang="en">
<head>
    <title>three.js ar - hit test</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body {
            background-color: aqua;
            color: #fff;
            font-family: "Lato", sans-serif;
        }

        .sidenav {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1;
            top: 0;
            left: 0;
            background-color: #111;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
        }

        .sidenav a {
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-size: 25px;
            color: #818181;
            display: block;
            transition: 0.3s;
        }

        .sidenav a:hover {
            color: #f1f1f1;
        }

        .sidenav .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
        }

        @media screen and (max-height: 450px) {
            .sidenav {
                padding-top: 15px;
            }

            .sidenav a {
                font-size: 18px;
            }
        }

        #place-button {
            position: absolute;
            bottom: 20px;
            left: calc(50% - 50px);
            width: 100px;
            height: 35px;
            display: none;
        }

        #VRButton {
            margin-bottom: 70px !important;
        }

        video#camera-feed {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none; /* ซ่อนเมื่อไม่ใช้งาน */
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>

<div id="content">
    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <a class="ar-object" id="1" href="#">item_1</a>
        <a class="ar-object" id="2" href="#">item_2</a>
        <a class="ar-object" id="3" href="#">item_3</a>
        <a class="ar-object" id="4" href="#">item_4</a>
    </div>

    <div id="container" style="position: fixed;"></div>

    <video id="camera-feed" autoplay playsinline></video>

    <span style="font-size:30px;cursor:pointer;position: absolute;" onclick="openNav()">&#9776; open</span>

    <button type="button" id="place-button">PLACE</button>
</div>

<script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.133.1/build/three.module.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.133.1/examples/jsm/loaders/GLTFLoader.js';

    let scene, camera, renderer;

    // ฟังก์ชันตรวจสอบการรองรับ WebXR
    function supportsWebXR() {
        return navigator.xr && navigator.xr.isSessionSupported('immersive-ar');
    }

    // ฟังก์ชันขออนุญาตเข้าถึงกล้อง (สำหรับ fallback)
    async function requestCameraAccess() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            const videoElement = document.getElementById('camera-feed');
            videoElement.srcObject = stream;
            videoElement.style.display = 'block'; // แสดงกล้องเมื่อได้สิทธิ์
        } catch (error) {
            console.error("Camera access denied:", error);
            alert("Unable to access camera. Please allow camera access.");
        }
    }

    function openNav() {
        document.getElementById("mySidenav").style.width = "250px";
    }

    function closeNav() {
        document.getElementById("mySidenav").style.width = "0";
    }

    function init() {
        // ตรวจสอบว่ารองรับ WebXR หรือไม่
        if (supportsWebXR()) {
            console.log("WebXR supported");
        } else {
            // ถ้าไม่รองรับ WebXR ขอสิทธิ์เข้าถึงกล้องแบบ fallback
            requestCameraAccess();
        }

        container = document.createElement('div');
        document.getElementById("container").appendChild(container);

        scene = new THREE.Scene();
        window.scene = scene;

        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.001, 200);

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);

        // โหลดโมเดลเมื่อคลิกที่ item_1
        document.getElementById("1").addEventListener("click", () => {
            loadModel('https://raw.githubusercontent.com/juniorkanfwqgwg/AR-Web/main/3d/1.glb');
        });

        window.addEventListener('resize', onWindowResize, false);
    }

    function loadModel(url) {
        const loader = new GLTFLoader();
        loader.load(url, function (gltf) {
            scene.add(gltf.scene);
            animate(); // เริ่มการ animate เมื่อโหลดโมเดลเสร็จสิ้น
        }, undefined, function (error) {
            console.error('An error occurred loading the model:', error);
        });
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }

    // เริ่มการทำงาน
    init();

</script>

</body>
</html>
