<!DOCTYPE html>
<html lang="en">
<head>
    <title>“Rise by the Halo”</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body {
            background-color: aqua;
            color: #fff;
            font-family: "Lato", sans-serif;
        }

        #place-button {
            position: absolute;
            bottom: 20px;
            left: calc(50% - 50px);
            width: 100px;
            height: 35px;
            display: none;
        }

        video#camera-feed {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none; /* ซ่อนเมื่อไม่ใช้งาน */
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>

<div id="content">
    <video id="camera-feed" autoplay playsinline></video>

    <button type="button" id="place-button">PLACE</button>
</div>

<script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.133.1/build/three.module.js';
    import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.133.1/examples/jsm/webxr/ARButton.js';
    import { VRButton } from 'https://cdn.jsdelivr.net/npm/three@0.133.1/examples/jsm/webxr/VRButton.js';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.133.1/examples/jsm/controls/OrbitControls.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.133.1/examples/jsm/loaders/GLTFLoader.js';
    import { RGBELoader } from 'https://cdn.jsdelivr.net/npm/three@0.133.1/examples/jsm/loaders/RGBELoader.js';
    import { RoughnessMipmapper } from 'https://cdn.jsdelivr.net/npm/three@0.133.1/examples/jsm/utils/RoughnessMipmapper.js';

    var container;
    var camera, scene, renderer;
    var controller;
    var reticle, pmremGenerator, current_object, controls, isAR, envmap;
    var hitTestSource = null;
    var hitTestSourceRequested = false;
    let isCameraOpen = false;

    // ฟังก์ชันขอสิทธิ์เข้าถึงกล้อง
    async function requestCameraAccess() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            const videoElement = document.getElementById('camera-feed');
            videoElement.srcObject = stream;
            videoElement.style.display = 'block'; // แสดงกล้องเมื่อได้สิทธิ์
            isCameraOpen = true;
        } catch (error) {
            console.error("Camera access denied:", error);
            alert("Unable to access camera. Please allow camera access.");
        }
    }

    // ตรวจสอบว่าเบราว์เซอร์รองรับ WebXR หรือไม่
    async function init() {
        container = document.createElement('div');
        document.getElementById("content").appendChild(container);

        scene = new THREE.Scene();
        window.scene = scene;

        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.001, 200);

        var directionalLight = new THREE.DirectionalLight(0xdddddd, 1);
        directionalLight.position.set(0, 0, 1).normalize();
        scene.add(directionalLight);

        var ambientLight = new THREE.AmbientLight(0x222222);
        scene.add(ambientLight);

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        container.appendChild(renderer.domElement);

        pmremGenerator = new THREE.PMREMGenerator(renderer);
        pmremGenerator.compileEquirectangularShader();

        controls = new OrbitControls(camera, renderer.domElement);
        controls.addEventListener('change', render);
        controls.minDistance = 2;
        controls.maxDistance = 10;
        controls.target.set(0, 0, -0.2);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        document.body.appendChild(VRButton.createButton(renderer));

        let options = {
            requiredFeatures: ['hit-test'],
            optionalFeatures: ['dom-overlay'],
        }

        options.domOverlay = { root: document.getElementById('content') };

        // ตรวจสอบการรองรับ WebXR
        if (navigator.xr) {
            try {
                const sessionSupported = await navigator.xr.isSessionSupported('immersive-ar');
                if (sessionSupported) {
                    // ถ้า WebXR รองรับให้ใช้งาน AR
                    document.body.appendChild(ARButton.createButton(renderer, options));
                } else {
                    // ถ้าไม่รองรับ WebXR ใช้ getUserMedia
                    requestCameraAccess();
                }
            } catch (error) {
                console.error("Error checking WebXR support:", error);
                requestCameraAccess(); // fallback ใช้ getUserMedia
            }
        } else {
            // ถ้าไม่รองรับ WebXR ใช้ getUserMedia
            requestCameraAccess();
        }

        reticle = new THREE.Mesh(
            new THREE.RingBufferGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2),
            new THREE.MeshBasicMaterial()
        );
        reticle.matrixAutoUpdate = false;
        reticle.visible = false;
        scene.add(reticle);

        window.addEventListener('resize', onWindowResize, false);

        animate();
    }

    function loadModel(model) {
        // ใช้ RGBELoader เพื่อโหลด environment map จาก GitHub
        new RGBELoader()
            .setDataType(THREE.UnsignedByteType)
            .setPath('https://raw.githubusercontent.com/juniorkanfwqgwg/AR-Web/main/textures/')
            .load('photo_studio_01_1k.hdr', function (texture) {
                envmap = pmremGenerator.fromEquirectangular(texture).texture;
                scene.environment = envmap;
                texture.dispose();
                pmremGenerator.dispose();
                render();

                // โหลดโมเดล GLB จาก GitHub
                var loader = new GLTFLoader().setPath('https://raw.githubusercontent.com/juniorkanfwqgwg/AR-Web/main/3d/');
                loader.load(model + ".glb", function (glb) {
                    current_object = glb.scene;
                    scene.add(current_object);

                    arPlace();

                    var box = new THREE.Box3();
                    box.setFromObject(current_object);
                    box.center(controls.target);

                    controls.update();
                    render();
                });
            });
    }

    function arPlace() {
        if (reticle.visible) {
            current_object.position.setFromMatrixPosition(reticle.matrix);
            current_object.visible = true;
        }
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
        renderer.setAnimationLoop(render);
        requestAnimationFrame(animate);
        controls.update();
    }

    function render(timestamp, frame) {
        if (frame && isAR) {
            var referenceSpace = renderer.xr.getReferenceSpace();
            var session = renderer.xr.getSession();

            if (hitTestSourceRequested === false) {
                session.requestReferenceSpace('viewer').then(function (referenceSpace) {
                    session.requestHitTestSource({ space: referenceSpace }).then(function (source) {
                        hitTestSource = source;
                    });
                });

                session.addEventListener('end', function () {
                    hitTestSourceRequested = false;
                    hitTestSource = null;
                    isAR = false;
                    reticle.visible = false;

                    var box = new THREE.Box3();
                    box.setFromObject(current_object);
                    box.center(controls.target);
                    document.getElementById("place-button").style.display = "none";
                });

                hitTestSourceRequested = true;
            }

            if (hitTestSource) {
                var hitTestResults = frame.getHitTestResults(hitTestSource);
                if (hitTestResults.length) {
                    var hit = hitTestResults[0];
                    document.getElementById("place-button").style.display = "block";
                    reticle.visible = true;
                    reticle.matrix.fromArray(hit.getPose(referenceSpace).transform.matrix);
                } else {
                    reticle.visible = false;
                    document.getElementById("place-button").style.display = "none";
                }
            }
        }
        renderer.render(scene, camera);
    }

    init();

</script>

</body>
</html>
